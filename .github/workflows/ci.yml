# name: Video Conversion CI

# on:
#   workflow_dispatch:
  

# jobs:
#   build-and-test:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '20'
#         cache: 'npm'

#     # Install system dependencies required by Playwright
#     - name: Cache apt packages
#       uses: actions/cache@v3
#       with:
#         path: /var/cache/apt
#         key: ${{ runner.os }}-apt-${{ hashFiles('**/*.yml') }}

#     - name: Install npm dependencies
#       run: npm ci && npm i aws-sdk

#     - name: Cache Playwright browsers
#       uses: actions/cache@v3
#       with:
#         path: ~/.cache/ms-playwright
#         key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}


#     # Verify FFmpeg installation (from @ffmpeg-installer/ffmpeg)
#     - name: Verify FFmpeg
#       run: echo "Hii"


#   # New job to test video conversion with hardcoded inputs
#   video-conversion-test:
#     runs-on: ubuntu-latest
#     needs: build-and-test

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '20'
#         cache: 'npm'

#     # Install system dependencies required by Playwright
#     - name: Install system dependencies
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y \
#           libnss3 \
#           libnspr4 \
#           libatk1.0-0 \
#           libatk-bridge2.0-0 \
#           libcups2 \
#           libdrm2 \
#           libgtk-3-0 \
#           libgbm1 \
#           libasound2t64

#     - name: Install npm dependencies
#       run: npm ci && npm i aws-sdk

#     - name: Install Playwright browsers
#       run: npx playwright install --with-deps

#     - name: Create output directory
#       run: mkdir -p public

#     - name: âš™ï¸ Configure AWS Credentials
#       uses: aws-actions/configure-aws-credentials@v4
#       with:
#         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#         aws-region: ap-south-1
        
#     - name: ğŸ§ª Test AWS Connection
#       run: |
#         aws sts get-caller-identity
#         aws s3 ls s3://magicmotion-export/ --max-items 5 || echo "Bucket test completed"
#     - name: Run Video Converter SDK with hardcoded inputs
#       env:
#         S3_BUCKET_NAME: magicmotion-export
#       run: |
#         echo "ğŸ¬ Running Video Converter SDK..."
#         echo "ğŸ“ Using hardcoded inputs from basic-usage.js"
#         cd video-converter-sdk
#         timeout 600 node examples/basic-usage.js || echo "Video conversion completed or timed out"

#     - name: ğŸ“¤ Upload Results
#       uses: actions/upload-artifact@v4
#       with:
#         name: converted-videos-result
#         path: |
#           public/
#         retention-days: 1
convert-magic-motion:
  runs-on: ubuntu-latest
  outputs:
    api-data: ${{ steps.fetch-api.outputs.response }}
  steps:
  - name: ğŸ“¦ Checkout
    uses: actions/checkout@v4
      
  # STEP 1: Fetch data from MagicRoll API using http-request-action
  - name: ğŸŒ Fetch Project Data from MagicRoll API
    id: fetch-api
    uses: fjogeleit/http-request-action@v1
    with:
      url: "https://api.magicrollai.buzz/api/v1/project/${{ inputs.project_id }}/editdata"
      method: "GET"
      customHeaders: '{"Content-Type": "application/json", "Authorization": "Token ${{ secrets.MAGICROLL_API_KEY }}"}'
      timeout: 30000
      
  - name: ğŸ“Š Display API Response (Safe)
    run: |
      echo "ğŸš€ API GET test completed!"
      echo "ğŸ“‹ Project ID: ${{ inputs.project_id }}"
      echo "ğŸŒ API URL: https://api.magicrollai.buzz/api/v1/project/${{ inputs.project_id }}/editdata"
      echo "ğŸ“Š Response Status: ${{ steps.fetch-api.outputs.statusCode }}"
      
      echo ""
      echo "ğŸ“¤ Raw API Response (first 500 chars):"
      echo '${{ steps.fetch-api.outputs.response }}' | head -c 500
      
      echo ""
      echo "ğŸ“¤ API Response Length: $(echo '${{ steps.fetch-api.outputs.response }}' | wc -c)"
      
      # Save response to file for safer processing
      echo '${{ steps.fetch-api.outputs.response }}' > api-response-raw.txt
      
      echo ""
      echo "ğŸ” Response Analysis:"
      if echo '${{ steps.fetch-api.outputs.response }}' | jq empty 2>/dev/null; then
        echo "âœ… Valid JSON detected"
        echo ""
        echo "ğŸ“‹ Response Summary:"
        echo '${{ steps.fetch-api.outputs.response }}' | jq '{
          project_id: .project_id,
          magicmotion_count: (.magicmotion | length),
          motion_graphics_count: (.motion_graphics_data | length),
          enable_magic_motion: .enable_magic_motion
        }' 2>/dev/null || echo "Could not parse JSON structure"
      else
        echo "âŒ Invalid JSON detected"
        echo "ğŸ” First 200 characters of response:"
        echo '${{ steps.fetch-api.outputs.response }}' | head -c 200
        echo ""
        echo "ğŸ” Response type detection:"
        if echo '${{ steps.fetch-api.outputs.response }}' | grep -q "<!DOCTYPE\|<html"; then
          echo "ğŸ“„ HTML content detected (possibly error page)"
        elif echo '${{ steps.fetch-api.outputs.response }}' | grep -q "error\|Error\|ERROR"; then
          echo "ğŸš¨ Error message detected"
        else
          echo "â“ Unknown content type"
        fi
      fi
      
  - name: ğŸ“„ Upload Raw Response for Debugging
    uses: actions/upload-artifact@v4
    with:
      name: api-response-debug-${{ inputs.project_id }}-${{ github.run_id }}
      path: |
        api-response-raw.txt
      retention-days: 1